const addrsHeco = {
    'router': '0xED7d5F38C79115ca12fe6C0041abb22F0A06C300',
    'factory': '0xb0b670fc1F7724119963018DB0BfA86aDb22d941',
    'wht': '0x5545153ccfca01fbd7dd11c0b23ba694d9509a6f',
    'usdt': '0xa71edc38d189767582c38a3145b5873052c3e47a',
    'mdx': '0x25d2e80cb6b86881fd7e07dd263fb79f4abe033c',
    'husd': '0x0298c2b32eae4da002a15f36fdf7615bea3da047',
    'wht-usdt': '0x499B6E03749B4bAF95F9E70EeD5355b138EA6C31',
    'wht-mdx': '0x6Dd2993B50b365c707718b0807fC4e344c072eC2',
    'usdt-mdx': '0x615E6285c5944540fd8bd921c9c8c56739Fd1E13',
    'wht-husd': '0x3375afF2CAcF683b8FC34807B9443EB32e7Afff6',
    'usdt-husd': '0xdff86B408284dff30A7CAD7688fEdB465734501C',
    'mdx-husd': '0x59FC9FF2efe186f07E2B9F6c83F78086613e95F2'
}
const decimalsHeco = {
    'wht': 18,
    'usdt': 18,
    'mdx': 18,
    'husd': 8,
}
const baseTokensHeco = ['wht', 'usdt', 'mdx', 'husd']
const feeHeco = 0.003

const addrsBsc = {
    'router': '0x10ed43c718714eb63d5aa57b78b54704e256024e',
    'factory': '0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73',
    'wbnb': '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',
    'usdt': '0x55d398326f99059fF775485246999027B3197955',
    'cake': '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82',
    'busd': '0xe9e7cea3dedca5984780bafc599bd69add087d56',
    'wbnb-usdt': '0x16b9a82891338f9bA80E2D6970FddA79D1eb0daE',
    'wbnb-cake': '0x0eD7e52944161450477ee417DE9Cd3a859b14fD0',
    'usdt-cake': '0xA39Af17CE4a8eb807E076805Da1e2B8EA7D0755b',
    'wbnb-busd': '0x58F876857a02D6762E0101bb5C46A8c1ED44Dc16',
    'usdt-busd': '0x7EFaEf62fDdCCa950418312c6C91Aef321375A00',
    'cake-busd': '0x804678fa97d91B974ec2af3c843270886528a9E6'
}
const decimalsBsc = {
    'wbnb': 18,
    'usdt': 18,
    'cake': 18,
    'busd': 18,
}
const baseTokensBsc = ['wbnb', 'usdt', 'cake', 'busd']
const feeBsc = 0.0025

const addrsPolygon = {
    'router': '0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff',
    'factory': '0x5757371414417b8C6CAad45bAeF941aBc7d3Ab32',
    'wmatic': '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270',
    'usdt': '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
    'quick': '0x831753DD7087CaC61aB5644b308642cc1c33Dc13',
    'weth': '0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619',
    'wmatic-usdt': '0x604229c960e5CACF2aaEAc8Be68Ac07BA9dF81c3',
    'wmatic-quick': '0x019ba0325f1988213D448b3472fA1cf8D07618d7',
    'usdt-quick': '0x7641F96A2B7b4708bc9E8F4D7ca08E232C31A3Dd',
    'wmatic-weth': '0xadbF1854e5883eB8aa7BAf50705338739e558E5b',
    'usdt-weth': '0xF6422B997c7F54D1c6a6e103bcb1499EeA0a7046',
    'quick-weth': '0x1Bd06B96dd42AdA85fDd0795f3B4A79DB914ADD5'
}
const decimalsPolygon = {
    'wmatic': 18,
    'usdt': 6,
    'quick': 18,
    'weth': 18,
}
const baseTokensPolygon = ['wmatic', 'usdt', 'quick', 'weth']
const feePolygon = 0.003

const addrsEth = {
    'router': '0xd9e1cE17f2641f24aE83637ab66a2cca9C378B9F',
    'factory': '0xC0AEe478e3658e2610c5F7A4A2E1777cE9e4f2Ac',
    'weth': '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',
    'usdt': '0xdAC17F958D2ee523a2206206994597C13D831ec7',
    'usdc': '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
    'sushi': '0x6B3595068778DD592e39A122f4f5a5cF09C90fE2',
    'weth-usdt': '0x06da0fd433C1A5d7a4faa01111c044910A184553',
    'weth-usdc': '0x397FF1542f962076d0BFE58eA045FfA2d347ACa0',
    'usdt-usdc': '0xD86A120a06255Df8D4e2248aB04d4267E23aDfaA',
    'weth-sushi': '0x795065dCc9f64b5614C407a6EFDC400DA6221FB0',
    'usdt-sushi': '0x680A025Da7b1be2c204D7745e809919bCE074026',
    'usdc-sushi': '0xBa87dC891945dbB3CAeEaF822DE208D7eA89B298'
}
const decimalsEth = {
    'weth': 18,
    'usdt': 6,
    'usdc': 6,
    'sushi': 18,
}
const baseTokensEth = ['weth', 'usdt', 'usdc', 'sushi']
const feeEth = 0.003

let addrs = addrsHeco
let decimals = decimalsHeco
let baseTokens = baseTokensHeco
let fee = feeHeco

function setChain(chainId) {
    if (chainId == 1) {
        addrs = addrsEth
        decimals = decimalsEth
        baseTokens = baseTokensEth
        fee = feeEth
    }
    if (chainId == 56) {
        addrs = addrsBsc
        decimals = decimalsBsc
        baseTokens = baseTokensBsc
        fee = feeBsc
    }
    if (chainId == 128) {
        addrs = addrsHeco
        decimals = decimalsHeco
        baseTokens = baseTokensHeco
        fee = feeHeco
    }
    if (chainId == 137) {
        addrs = addrsPolygon
        decimals = decimalsPolygon
        baseTokens = baseTokensPolygon
        fee = feePolygon
    }
}

function getBaseDecimalsMap() {
    let decimalsMap = {}
    baseTokens.forEach((t) => {
        decimalsMap[addrs[t]] = decimals[t]
    })
    return decimalsMap
}

function getBasePairMap() {
    let pairMap = {}
    baseTokens.forEach((v) => {
        pairMap[addrs[v]] = {}
    })
    baseTokens.forEach((v) => {
        baseTokens.forEach((vv) => {
            if (v != vv) {
                const pairKey1 = v + '-' + vv
                const pairKey2 = vv + '-' + v
                if (pairKey1 in addrs) {
                    pairMap[addrs[v]][addrs[vv]] = addrs[pairKey1]
                } else if (pairKey2 in addrs) {
                    pairMap[addrs[v]][addrs[vv]] = addrs[pairKey2]
                }
            }
        })
    })
    return pairMap
}

function extendPairSet(web3, factoryContract, tokenA, tokenB) {
    let pairMap = getBasePairMap()
    const tokenAAndTokenB = [tokenA,tokenB]
    
    tokenAAndTokenB.forEach(t => {
        if (!pairMap.hasOwnProperty(t)) {
            pairMap[t] = {}
        }
    })

    let requestDatas = []
    requestDatas.push([tokenA, tokenB])
    tokenAAndTokenB.forEach(v => {
        baseTokens.forEach(vv => {
            requestDatas.push([v, addrs[vv]])
        })
    })

    return new Promise(resolve => {
        const batch = new web3.eth.BatchRequest()
        const targetCount = requestDatas.length
        let i = 0
        requestDatas.forEach(d => {
            batch.add(factoryContract.methods.getPair(d[0], d[1]).call.request({}, (_, data) => {
                if (data) {
                    if (!data.endsWith('000000000000000')) {
                        pairMap[d[0]][d[1]] = data
                        pairMap[d[1]][d[0]] = data
                    }
                }
                if (targetCount == ++i) {
                    resolve(pairMap)
                }
            }))
        })
        batch.execute()
    })
}

function getWeightByAmountIn(web3, routerContract, paths, amountIn) {
    return new Promise(resolve => {
        let pathWeights = []
        const batch = new web3.eth.BatchRequest()
        const targetCount = paths.length
        let i = 0
        paths.forEach(p => {
            batch.add(routerContract.methods.getAmountsOut(amountIn, p).call.request({}, (_, data) => {
                if (data) {
                    pathWeights.push([p, data])
                }
                if (targetCount == ++i) {
                    resolve(pathWeights)
                }
            }))
        })
        batch.execute()
    })
}
function getWeightByAmountOut(web3, routerContract, paths, amountOut) {
    return new Promise(resolve => {
        let pathWeights = []
        const batch = new web3.eth.BatchRequest()
        const targetCount = paths.length
        let i = 0
        paths.forEach(p => {
            batch.add(routerContract.methods.getAmountsIn(amountOut, p).call.request({}, (_, data) => {
                if (data) {
                    pathWeights.push([p, data])
                }
                if (targetCount == ++i) {
                    resolve(pathWeights)
                }
            }))
        })
        batch.execute()
    })
}

async function routerCalcRaw(web3, factoryAbi, routerAbi, tokenA, tokenB, amountIn, amountOut) {
    const factoryContract = new web3.eth.Contract(factoryAbi, addrs.factory)
    let pairMap = await extendPairSet(web3, factoryContract, tokenA, tokenB)

    let paths = []
    if (tokenB in pairMap[tokenA]) {
        paths.push([tokenA, tokenB])
    }
    Object.keys(pairMap[tokenA]).forEach(t => {
        if (tokenB in pairMap[t]) {
            paths.push([tokenA, t, tokenB])
        }
    })

    Object.keys(pairMap[tokenA]).forEach(t => {
        Object.keys(pairMap[tokenB]).forEach(tt => {
            if (tt in pairMap[t]) {
                paths.push([tokenA, t, tt, tokenB])
            }
        })
    })
    if (paths.length == 0) {
        return [undefined,undefined,1]
    }

    const routerContract = new web3.eth.Contract(routerAbi, addrs.router)
    if (amountIn > 0) {
        const pathWeights = await getWeightByAmountIn(web3, routerContract, paths, amountIn)
        if (pathWeights.length == 0) {
            return [undefined,undefined,2]
        }
        const sorted = pathWeights.sort((a, b) => a[1][a[1].length - 1] - b[1][b[1].length - 1])
        return [sorted[sorted.length - 1], pairMap, 0]
    } else {
        const pathWeights = await getWeightByAmountOut(web3, routerContract, paths, amountOut)
        if (pathWeights.length == 0) {
            return [undefined,undefined,2]
        }
        const sorted = pathWeights.sort((a, b) => a[1][0] - b[1][0])
        return [sorted[0], pairMap, 0]
    }
}

async function routerCalc(web3, factoryAbi, routerAbi, tokenA, tokenB, amountIn, amountOut) {
    return (await routerCalcRaw(web3, factoryAbi, routerAbi, tokenA, tokenB, amountIn, amountOut))[0]
}

async function priceAffect2(web3, tokenAbi, factoryAbi, routerAbi, tokenA, tokenB, amountA) {
    console.log(tokenA,tokenB)
    // let [[path, weigh], pairMap] = await routerCalcRaw(web3, factoryAbi, routerAbi, tokenA, tokenB, amountA, 0)
    let routerInfo = await routerCalcRaw(web3, factoryAbi, routerAbi, tokenA, tokenB, amountA, 0)
    if (routerInfo[2] > 0) {
        // 0为正常，1为不存在任何交易对，2为存在交易对，但不存在任何流动性
        return [undefined,undefined,undefined,routerInfo[2]]
    }
    let [[path, weigh], pairMap, ] = routerInfo
    let decimalsMap = getBaseDecimalsMap()
    const tokenAContract = new web3.eth.Contract(tokenAbi, tokenA)
    const tokenBContract = new web3.eth.Contract(tokenAbi, tokenB)
    decimalsMap[tokenA] = await tokenAContract.methods.decimals().call()
    decimalsMap[tokenB] = await tokenBContract.methods.decimals().call()

    // const factoryContract = new web3.eth.Contract(factoryAbi, addrs.factory)
    let priceBefore = web3.utils.toBN('1')
    let priceAfter = web3.utils.toBN('1')

    for (let i = 0; i < path.length - 1; i++) {
        // const pairAddr = await factoryContract.methods.getPair(path[i], path[i + 1]).call()
        const pairAddr = pairMap[path[i]][path[i + 1]]
        const tokenI0Contract = new web3.eth.Contract(tokenAbi, path[i])
        const tokenI1Contract = new web3.eth.Contract(tokenAbi, path[i + 1])
        const reserveI0 = await tokenI0Contract.methods.balanceOf(pairAddr).call()
        const reserveI1 = await tokenI1Contract.methods.balanceOf(pairAddr).call()
        const baseI0 = 10 ** decimalsMap[path[i]]
        const baseI1 = 10 ** decimalsMap[path[i + 1]]
        priceBefore = priceBefore * reserveI0 / baseI0 / reserveI1 * baseI1
        priceAfter = priceAfter * (web3.utils.toBN(reserveI0).add(web3.utils.toBN(weigh[i]))) / baseI0 / (reserveI1 - weigh[i + 1]) * baseI1
    }
    let priceSwap = priceBefore
    if (weigh[weigh.length - 1] > 0) {
        const [baseA, baseB] = [10 ** decimalsMap[tokenA], 10 ** decimalsMap[tokenB]]
        priceSwap = web3.utils.toBN(weigh[0]) / baseA / weigh[weigh.length - 1] * baseB
        priceSwap = priceSwap * (1 - fee)**(path.length - 1)
    }
    // console.log("price", priceBefore, web3.utils.toBN(weigh[0]) / decimals0 / weigh[weigh.length - 1] * decimals1, priceAfter)
    console.log(priceBefore, priceSwap, priceAfter)
    return [priceBefore, priceSwap, priceAfter, 0]
}

const hre = require("hardhat");
const { web3, ethers } = hre;
require("@nomiclabs/hardhat-web3");
require("@nomiclabs/hardhat-ethers");

const abis = {
    'factory': require('./abis/factory.json'),
    'router': require('./abis/router.json'),
    'token': require('./abis/token.json')
}

const addrsTemp = {
    'usdt': '0xa71edc38d189767582c38a3145b5873052c3e47a',
    'usdc':'0x9362bbef4b8313a8aa9f0c9808b80577aa26b73b',
    'link':'0x9e004545c59d359f6b7bfb06a26390b087717b42',
    'wht': '0x5545153ccfca01fbd7dd11c0b23ba694d9509a6f',
    'husd': '0x0298c2b32eae4da002a15f36fdf7615bea3da047',
    // 'temp': '0xC7f7a54892B78b5c812c58d9Df8035FcE9F4D445'
    // 'temp': '0xb88a58EC2115fFBaA9ce2578A88e06C9aCE16285'
    'temp': '0x6bce534a02f8347f747124082ef3e35dd696748d'
}

priceAffect2(web3, abis.token,abis.factory,abis.router,addrsTemp.usdt,addrsTemp.temp,ethers.utils.parseUnits('0.1',18))
.then(console.log).catch(console.log)

// routerCalcRaw(web3, abis.factory,abis.router,addrsTemp.usdc,addrsTemp.link,ethers.utils.parseUnits('1',6),0)
// .then(console.log).catch(console.log)